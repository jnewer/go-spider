<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">高级查询</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="智能选择字段" class="article-heading"><a href="#智能选择字段" class="headerlink" title="智能选择字段"></a><span id="smart_select">智能选择字段</span><a class="article-anchor" href="#智能选择字段" aria-hidden="true"></a></h2><p>GORM 允许通过 <a href="query.html"><code>Select</code></a> 方法选择特定的字段，如果您在应用程序中经常使用此功能，你也可以定义一个较小的结构体，以实现调用 API 时自动选择特定的字段，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID     <span class="type">uint</span></span><br><span class="line">  Name   <span class="type">string</span></span><br><span class="line">  Age    <span class="type">int</span></span><br><span class="line">  Gender <span class="type">string</span></span><br><span class="line">  <span class="comment">// 假设后面还有几百个字段...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> APIUser <span class="keyword">struct</span> {</span><br><span class="line">  ID   <span class="type">uint</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询时会自动选择 `id`, `name` 字段</span></span><br><span class="line">db.Model(&amp;User{}).Limit(<span class="number">10</span>).Find(&amp;APIUser{})</span><br><span class="line"><span class="comment">// SELECT `id`, `name` FROM `users` LIMIT 10</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意</strong> <code>QueryFields</code> 模式会根据当前 model 的所有字段名称进行 select。</p></blockquote><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"gorm.db"</span>), &amp;gorm.Config{</span><br><span class="line">  QueryFields: <span class="literal">true</span>,</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">db.Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // 带上这个选项</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Session Mode</span></span><br><span class="line">db.Session(&amp;gorm.Session{QueryFields: <span class="literal">true</span>}).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users`</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Locking-FOR-UPDATE" class="article-heading"><a href="#Locking-FOR-UPDATE" class="headerlink" title="Locking (FOR UPDATE)"></a>Locking (FOR UPDATE)<a class="article-anchor" href="#Locking-FOR-UPDATE" aria-hidden="true"></a></h2><p>GORM 支持多种类型的锁，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Clauses(clause.Locking{Strength: <span class="string">"UPDATE"</span>}).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FOR UPDATE</span></span><br><span class="line"></span><br><span class="line">db.Clauses(clause.Locking{</span><br><span class="line">  Strength: <span class="string">"SHARE"</span>,</span><br><span class="line">  Table: clause.Table{Name: clause.CurrentTable},</span><br><span class="line">}).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FOR SHARE OF `users`</span></span><br><span class="line"></span><br><span class="line">db.Clauses(clause.Locking{</span><br><span class="line">  Strength: <span class="string">"UPDATE"</span>,</span><br><span class="line">  Options: <span class="string">"NOWAIT"</span>,</span><br><span class="line">}).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FOR UPDATE NOWAIT</span></span><br></pre></td></tr></tbody></table></figure><p>查看 <a href="sql_builder.html">原生 SQL 及构造器</a> 获取详情</p><h2 id="子查询" class="article-heading"><a href="#子查询" class="headerlink" title="子查询"></a>子查询<a class="article-anchor" href="#子查询" aria-hidden="true"></a></h2><p>子查询可以嵌套在查询中，GORM 允许在使用 <code>*gorm.DB</code> 对象作为参数时生成子查询</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"amount &gt; (?)"</span>, db.Table(<span class="string">"orders"</span>).Select(<span class="string">"AVG(amount)"</span>)).Find(&amp;orders)</span><br><span class="line"><span class="comment">// SELECT * FROM "orders" WHERE amount &gt; (SELECT AVG(amount) FROM "orders");</span></span><br><span class="line"></span><br><span class="line">subQuery := db.Select(<span class="string">"AVG(age)"</span>).Where(<span class="string">"name LIKE ?"</span>, <span class="string">"name%"</span>).Table(<span class="string">"users"</span>)</span><br><span class="line">db.Select(<span class="string">"AVG(age) as avgage"</span>).Group(<span class="string">"name"</span>).Having(<span class="string">"AVG(age) &gt; (?)"</span>, subQuery).Find(&amp;results)</span><br><span class="line"><span class="comment">// SELECT AVG(age) as avgage FROM `users` GROUP BY `name` HAVING AVG(age) &gt; (SELECT AVG(age) FROM `users` WHERE name LIKE "name%")</span></span><br></pre></td></tr></tbody></table></figure><h3 id="From-子查询" class="article-heading"><a href="#From-子查询" class="headerlink" title="From 子查询"></a><span id="from_subquery">From 子查询</span><a class="article-anchor" href="#From-子查询" aria-hidden="true"></a></h3><p>GORM 允许您在 <code>Table</code> 方法中通过 FROM 子句使用子查询，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Table(<span class="string">"(?) as u"</span>, db.Model(&amp;User{}).Select(<span class="string">"name"</span>, <span class="string">"age"</span>)).Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM (SELECT `name`,`age` FROM `users`) as u WHERE `age` = 18</span></span><br><span class="line"></span><br><span class="line">subQuery1 := db.Model(&amp;User{}).Select(<span class="string">"name"</span>)</span><br><span class="line">subQuery2 := db.Model(&amp;Pet{}).Select(<span class="string">"name"</span>)</span><br><span class="line">db.Table(<span class="string">"(?) as u, (?) as p"</span>, subQuery1, subQuery2).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM (SELECT `name` FROM `users`) as u, (SELECT `name` FROM `pets`) as p</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Group-条件" class="article-heading"><a href="#Group-条件" class="headerlink" title="Group 条件"></a><span id="group_conditions">Group 条件</span><a class="article-anchor" href="#Group-条件" aria-hidden="true"></a></h2><p>使用 Group 条件可以更轻松的编写复杂 SQL</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(</span><br><span class="line">    db.Where(<span class="string">"pizza = ?"</span>, <span class="string">"pepperoni"</span>).Where(db.Where(<span class="string">"size = ?"</span>, <span class="string">"small"</span>).Or(<span class="string">"size = ?"</span>, <span class="string">"medium"</span>)),</span><br><span class="line">).Or(</span><br><span class="line">    db.Where(<span class="string">"pizza = ?"</span>, <span class="string">"hawaiian"</span>).Where(<span class="string">"size = ?"</span>, <span class="string">"xlarge"</span>),</span><br><span class="line">).Find(&amp;Pizza{}).Statement</span><br><span class="line"></span><br><span class="line"><span class="comment">// SELECT * FROM `pizzas` WHERE (pizza = "pepperoni" AND (size = "small" OR size = "medium")) OR (pizza = "hawaiian" AND size = "xlarge")</span></span><br></pre></td></tr></tbody></table></figure><h2 id="带多个列的-In" class="article-heading"><a href="#带多个列的-In" class="headerlink" title="带多个列的 In"></a>带多个列的 In<a class="article-anchor" href="#带多个列的-In" aria-hidden="true"></a></h2><p>带多个列的 In 查询</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"(name, age, role) IN ?"</span>, [][]<span class="keyword">interface</span>{}{{<span class="string">"jinzhu"</span>, <span class="number">18</span>, <span class="string">"admin"</span>}, {<span class="string">"jinzhu2"</span>, <span class="number">19</span>, <span class="string">"user"</span>}}).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE (name, age, role) IN (("jinzhu", 18, "admin"), ("jinzhu 2", 19, "user"));</span></span><br></pre></td></tr></tbody></table></figure><h2 id="命名参数" class="article-heading"><a href="#命名参数" class="headerlink" title="命名参数"></a>命名参数<a class="article-anchor" href="#命名参数" aria-hidden="true"></a></h2><p>GORM 支持 <a target="_blank" rel="noopener" href="https://tip.golang.org/pkg/database/sql/#NamedArg"><code>sql.NamedArg</code></a> 和 <code>map[string]interface{}{}</code> 形式的命名参数，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"name1 = @name OR name2 = @name"</span>, sql.Named(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>)).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE name1 = "jinzhu" OR name2 = "jinzhu"</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"name1 = @name OR name2 = @name"</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"jinzhu"</span>}).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE name1 = "jinzhu" OR name2 = "jinzhu" ORDER BY `users`.`id` LIMIT 1</span></span><br></pre></td></tr></tbody></table></figure><p>查看 <a href="sql_builder.html#named_argument">原生 SQL 及构造器</a> 获取详情</p><h2 id="Find-至-map" class="article-heading"><a href="#Find-至-map" class="headerlink" title="Find 至 map"></a>Find 至 map<a class="article-anchor" href="#Find-至-map" aria-hidden="true"></a></h2><p>GORM 允许扫描结果至 <code>map[string]interface{}</code> 或 <code>[]map[string]interface{}</code>，此时别忘了指定 <code>Model</code> 或 <code>Table</code>，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">result := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{}</span><br><span class="line">db.Model(&amp;User{}).First(&amp;result, <span class="string">"id = ?"</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> results []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}</span><br><span class="line">db.Table(<span class="string">"users"</span>).Find(&amp;results)</span><br></pre></td></tr></tbody></table></figure><h2 id="FirstOrInit" class="article-heading"><a href="#FirstOrInit" class="headerlink" title="FirstOrInit"></a>FirstOrInit<a class="article-anchor" href="#FirstOrInit" aria-hidden="true"></a></h2><p>获取第一条匹配的记录，或者根据给定的条件初始化一个实例（仅支持 sturct 和 map 条件）</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，则根据给定的条件初始化一条记录</span></span><br><span class="line">db.FirstOrInit(&amp;user, User{Name: <span class="string">"non_existing"</span>})</span><br><span class="line"><span class="comment">// user -&gt; User{Name: "non_existing"}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user</span></span><br><span class="line">db.Where(User{Name: <span class="string">"jinzhu"</span>}).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "Jinzhu", Age: 18}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user</span></span><br><span class="line">db.FirstOrInit(&amp;user, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"jinzhu"</span>})</span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "Jinzhu", Age: 18}</span></span><br></pre></td></tr></tbody></table></figure><p>如果没有找到记录，可以使用包含更多的属性的结构体初始化 user，<code>Attrs</code> 不会被用于生成查询 SQL</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，则根据给定的条件以及 Attrs 初始化 user</span></span><br><span class="line">db.Where(User{Name: <span class="string">"non_existing"</span>}).Attrs(User{Age: <span class="number">20</span>}).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = 'non_existing' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User{Name: "non_existing", Age: 20}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 未找到 user，则根据给定的条件以及 Attrs 初始化 user</span></span><br><span class="line">db.Where(User{Name: <span class="string">"non_existing"</span>}).Attrs(<span class="string">"age"</span>, <span class="number">20</span>).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = 'non_existing' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User{Name: "non_existing", Age: 20}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user，则忽略 Attrs</span></span><br><span class="line">db.Where(User{Name: <span class="string">"Jinzhu"</span>}).Attrs(User{Age: <span class="number">20</span>}).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = jinzhu' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "Jinzhu", Age: 18}</span></span><br></pre></td></tr></tbody></table></figure><p>不管是否找到记录，<code>Assign</code> 都会将属性赋值给 struct，但这些属性不会被用于生成查询 SQL，也不会被保存到数据库</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，根据条件和 Assign 属性初始化 struct</span></span><br><span class="line">db.Where(User{Name: <span class="string">"non_existing"</span>}).Assign(User{Age: <span class="number">20</span>}).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// user -&gt; User{Name: "non_existing", Age: 20}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到 `name` = `jinzhu` 的记录，依然会更新 Assign 相关的属性</span></span><br><span class="line">db.Where(User{Name: <span class="string">"Jinzhu"</span>}).Assign(User{Age: <span class="number">20</span>}).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = jinzhu' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "Jinzhu", Age: 20}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="FirstOrCreate" class="article-heading"><a href="#FirstOrCreate" class="headerlink" title="FirstOrCreate"></a>FirstOrCreate<a class="article-anchor" href="#FirstOrCreate" aria-hidden="true"></a></h2><p>Get first matched record or create a new one with given conditions (only works with struct, map conditions), <code>RowsAffected</code> returns created/updated record’s count</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// User not found, create a new record with give conditions</span></span><br><span class="line">result := db.FirstOrCreate(&amp;user, User{Name: <span class="string">"non_existing"</span>})</span><br><span class="line"><span class="comment">// INSERT INTO "users" (name) VALUES ("non_existing");</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 112, Name: "non_existing"}</span></span><br><span class="line"><span class="comment">// result.RowsAffected // =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Found user with `name` = `jinzhu`</span></span><br><span class="line">result := db.Where(User{Name: <span class="string">"jinzhu"</span>}).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "jinzhu", "Age": 18}</span></span><br><span class="line"><span class="comment">// result.RowsAffected // =&gt; 0</span></span><br></pre></td></tr></tbody></table></figure><p>如果没有找到记录，可以使用包含更多的属性的结构体创建记录，<code>Attrs</code> 不会被用于生成查询 SQL 。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，根据条件和 Assign 属性创建记录</span></span><br><span class="line">db.Where(User{Name: <span class="string">"non_existing"</span>}).Attrs(User{Age: <span class="number">20</span>}).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'non_existing' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// INSERT INTO "users" (name, age) VALUES ("non_existing", 20);</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 112, Name: "non_existing", Age: 20}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user，则忽略 Attrs</span></span><br><span class="line">db.Where(User{Name: <span class="string">"jinzhu"</span>}).Attrs(User{Age: <span class="number">20</span>}).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "jinzhu", Age: 18}</span></span><br></pre></td></tr></tbody></table></figure><p>不管是否找到记录，<code>Assign</code> 都会将属性赋值给 struct，并将结果写回数据库</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，根据条件和 Assign 属性创建记录</span></span><br><span class="line">db.Where(User{Name: <span class="string">"non_existing"</span>}).Assign(User{Age: <span class="number">20</span>}).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'non_existing' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// INSERT INTO "users" (name, age) VALUES ("non_existing", 20);</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 112, Name: "non_existing", Age: 20}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user，依然会根据 Assign 更新记录</span></span><br><span class="line">db.Where(User{Name: <span class="string">"jinzhu"</span>}).Assign(User{Age: <span class="number">20</span>}).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// UPDATE users SET age=20 WHERE id = 111;</span></span><br><span class="line"><span class="comment">// user -&gt; User{ID: 111, Name: "jinzhu", Age: 20}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="优化器、索引提示" class="article-heading"><a href="#优化器、索引提示" class="headerlink" title="优化器、索引提示"></a>优化器、索引提示<a class="article-anchor" href="#优化器、索引提示" aria-hidden="true"></a></h2><p>优化器提示用于控制查询优化器选择某个查询执行计划，GORM 通过 <code>gorm.io/hints</code> 提供支持，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/hints"</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.New(<span class="string">"MAX_EXECUTION_TIME(10000)"</span>)).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * /*+ MAX_EXECUTION_TIME(10000) */ FROM `users`</span></span><br></pre></td></tr></tbody></table></figure><p>索引提示允许传递索引提示到数据库，以防查询计划器出现混乱。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/hints"</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.UseIndex(<span class="string">"idx_user_name"</span>)).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM `users` USE INDEX (`idx_user_name`)</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.ForceIndex(<span class="string">"idx_user_name"</span>, <span class="string">"idx_user_id"</span>).ForJoin()).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)"</span></span><br></pre></td></tr></tbody></table></figure><p>参考 <a href="hints.html">优化器提示、索引、备注</a> 获取详情</p><h2 id="迭代" class="article-heading"><a href="#迭代" class="headerlink" title="迭代"></a>迭代<a class="article-anchor" href="#迭代" aria-hidden="true"></a></h2><p>GORM 支持通过行进行迭代</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">rows, err := db.Model(&amp;User{}).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Rows()</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rows.Next() {</span><br><span class="line">  <span class="keyword">var</span> user User</span><br><span class="line">  <span class="comment">// ScanRows 方法用于将一行记录扫描至结构体</span></span><br><span class="line">  db.ScanRows(rows, &amp;user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 业务逻辑...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="FindInBatches" class="article-heading"><a href="#FindInBatches" class="headerlink" title="FindInBatches"></a>FindInBatches<a class="article-anchor" href="#FindInBatches" aria-hidden="true"></a></h2><p>用于批量查询并处理记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 每次批量处理 100 条</span></span><br><span class="line">result := db.Where(<span class="string">"processed = ?"</span>, <span class="literal">false</span>).FindInBatches(&amp;results, <span class="number">100</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB, batch <span class="type">int</span>)</span></span> <span class="type">error</span> {</span><br><span class="line">  <span class="keyword">for</span> _, result := <span class="keyword">range</span> results {</span><br><span class="line">    <span class="comment">// 批量处理找到的记录</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  tx.Save(&amp;results)</span><br><span class="line"></span><br><span class="line">  tx.RowsAffected <span class="comment">// 本次批量操作影响的记录数</span></span><br><span class="line"></span><br><span class="line">  batch <span class="comment">// Batch 1, 2, 3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果返回错误会终止后续批量操作</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">result.Error <span class="comment">// returned error</span></span><br><span class="line">result.RowsAffected <span class="comment">// 整个批量操作影响的记录数</span></span><br></pre></td></tr></tbody></table></figure><h2 id="查询钩子" class="article-heading"><a href="#查询钩子" class="headerlink" title="查询钩子"></a>查询钩子<a class="article-anchor" href="#查询钩子" aria-hidden="true"></a></h2><p>对于查询操作，GORM 支持 <code>AfterFind</code> 钩子，查询记录后会调用它，详情请参考 <a href="hooks.html">钩子</a></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> AfterFind(tx *gorm.DB) (err <span class="type">error</span>) {</span><br><span class="line">  <span class="keyword">if</span> u.Role == <span class="string">""</span> {</span><br><span class="line">    u.Role = <span class="string">"user"</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="Pluck" class="article-heading"><a href="#Pluck" class="headerlink" title="Pluck"></a><span id="pluck">Pluck</span><a class="article-anchor" href="#Pluck" aria-hidden="true"></a></h2><p>Pluck 用于从数据库查询单个列，并将结果扫描到切片。如果您想要查询多列，您应该使用 <code>Select</code> 和 <a href="query.html#scan"><code>Scan</code></a></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ages []<span class="type">int64</span></span><br><span class="line">db.Model(&amp;users).Pluck(<span class="string">"age"</span>, &amp;ages)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> names []<span class="type">string</span></span><br><span class="line">db.Model(&amp;User{}).Pluck(<span class="string">"name"</span>, &amp;names)</span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"deleted_users"</span>).Pluck(<span class="string">"name"</span>, &amp;names)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Distinct Pluck</span></span><br><span class="line">db.Model(&amp;User{}).Distinct().Pluck(<span class="string">"Name"</span>, &amp;names)</span><br><span class="line"><span class="comment">// SELECT DISTINCT `name` FROM `users`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 超过一列的查询，应该使用 `Scan` 或者 `Find`，例如：</span></span><br><span class="line">db.Select(<span class="string">"name"</span>, <span class="string">"age"</span>).Scan(&amp;users)</span><br><span class="line">db.Select(<span class="string">"name"</span>, <span class="string">"age"</span>).Find(&amp;users)</span><br></pre></td></tr></tbody></table></figure><h2 id="Scope" class="article-heading"><a href="#Scope" class="headerlink" title="Scope"></a>Scope<a class="article-anchor" href="#Scope" aria-hidden="true"></a></h2><p><code>Scopes</code> 允许你指定常用的查询，可以在调用方法时引用这些查询</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AmountGreaterThan1000</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB {</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">"amount &gt; ?"</span>, <span class="number">1000</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PaidWithCreditCard</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB {</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">"pay_mode_sign = ?"</span>, <span class="string">"C"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PaidWithCod</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB {</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">"pay_mode_sign = ?"</span>, <span class="string">"C"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OrderStatus</span><span class="params">(status []<span class="type">string</span>)</span></span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span></span> *gorm.DB {</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span></span> *gorm.DB {</span><br><span class="line">    <span class="keyword">return</span> db.Where(<span class="string">"status IN (?)"</span>, status)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, PaidWithCreditCard).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 的信用卡订单</span></span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, PaidWithCod).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 的货到付款订单</span></span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, OrderStatus([]<span class="type">string</span>{<span class="string">"paid"</span>, <span class="string">"shipped"</span>})).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 且已付款或已发货的订单</span></span><br></pre></td></tr></tbody></table></figure><p>查看 <a href="scopes.html">Scopes</a> 获取详情</p><h2 id="Count" class="article-heading"><a href="#Count" class="headerlink" title="Count"></a><span id="count">Count</span><a class="article-anchor" href="#Count" aria-hidden="true"></a></h2><p>Count 用于获取匹配的记录数</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> count <span class="type">int64</span></span><br><span class="line">db.Model(&amp;User{}).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Or(<span class="string">"name = ?"</span>, <span class="string">"jinzhu 2"</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(1) FROM users WHERE name = 'jinzhu' OR name = 'jinzhu 2'</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{}).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(1) FROM users WHERE name = 'jinzhu'; (count)</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"deleted_users"</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(1) FROM deleted_users;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Count with Distinct</span></span><br><span class="line">db.Model(&amp;User{}).Distinct(<span class="string">"name"</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT COUNT(DISTINCT(`name`)) FROM `users`</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"deleted_users"</span>).Select(<span class="string">"count(distinct(name))"</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(distinct(name)) FROM deleted_users</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Count with Group</span></span><br><span class="line">users := []User{</span><br><span class="line">  {Name: <span class="string">"name1"</span>},</span><br><span class="line">  {Name: <span class="string">"name2"</span>},</span><br><span class="line">  {Name: <span class="string">"name3"</span>},</span><br><span class="line">  {Name: <span class="string">"name3"</span>},</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{}).Group(<span class="string">"name"</span>).Count(&amp;count)</span><br><span class="line">count <span class="comment">// =&gt; 3</span></span><br></pre></td></tr></tbody></table></figure></body></html>              </div>                            <div>