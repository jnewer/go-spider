<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">Many To Many</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="Many-To-Many" class="article-heading"><a href="#Many-To-Many" class="headerlink" title="Many To Many"></a>Many To Many<a class="article-anchor" href="#Many-To-Many" aria-hidden="true"></a></h2><p>Many to Many 会在两个 model 中添加一张连接表。</p><p>例如，您的应用包含了 user 和 language，且一个 user 可以说多种 language，多个 user 也可以说一种 language。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// User 拥有并属于多种 language，`user_languages` 是连接表</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:"many2many:user_languages;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>当使用 GORM 的 <code>AutoMigrate</code> 为 <code>User</code> 创建表时，GORM 会自动创建连接表</p><h2 id="反向引用" class="article-heading"><a href="#反向引用" class="headerlink" title="反向引用"></a>反向引用<a class="article-anchor" href="#反向引用" aria-hidden="true"></a></h2><h3 id="Declare" class="article-heading"><a href="#Declare" class="headerlink" title="Declare"></a>Declare<a class="article-anchor" href="#Declare" aria-hidden="true"></a></h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// User 拥有并属于多种 language，`user_languages` 是连接表</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []*Language <span class="string">`gorm:"many2many:user_languages;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Users []*User <span class="string">`gorm:"many2many:user_languages;"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Retrieve" class="article-heading"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve<a class="article-anchor" href="#Retrieve" aria-hidden="true"></a></h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Retrieve user list with edger loading languages</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetAllUsers</span><span class="params">(db *gorm.DB)</span></span> ([]User, <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">var</span> users []User</span><br><span class="line">    err := db.Model(&amp;User{}).Preload(<span class="string">"Languages"</span>).Find(&amp;users).Error</span><br><span class="line">    <span class="keyword">return</span> users, err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retrieve language list with edger loading users</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetAllLanguages</span><span class="params">(db *gorm.DB)</span></span> ([]Language, <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">var</span> languages []Language</span><br><span class="line">    err := db.Model(&amp;Language{}).Preload(<span class="string">"Users"</span>).Find(&amp;languages).Error</span><br><span class="line">    <span class="keyword">return</span> languages, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="重写外键" class="article-heading"><a href="#重写外键" class="headerlink" title="重写外键"></a>重写外键<a class="article-anchor" href="#重写外键" aria-hidden="true"></a></h2><p>对于 <code>many2many</code> 关系，连接表会同时拥有两个模型的外键，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:"many2many:user_languages;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Join Table: user_languages</span></span><br><span class="line"><span class="comment">//   foreign key: user_id, reference: users.id</span></span><br><span class="line"><span class="comment">//   foreign key: language_id, reference: languages.id</span></span><br></pre></td></tr></tbody></table></figure><p>若要重写它们，可以使用标签 <code>foreignKey</code>、<code>references</code>、<code>joinforeignKey</code>、<code>joinReferences</code>。当然，您不需要使用全部的标签，你可以仅使用其中的一个重写部分的外键、引用。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">    gorm.Model</span><br><span class="line">    Profiles []Profile <span class="string">`gorm:"many2many:user_profiles;foreignKey:Refer;joinForeignKey:UserReferID;References:UserRefer;joinReferences:ProfileRefer"`</span></span><br><span class="line">    Refer    <span class="type">uint</span>      <span class="string">`gorm:"index:,unique"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Profile <span class="keyword">struct</span> {</span><br><span class="line">    gorm.Model</span><br><span class="line">    Name      <span class="type">string</span></span><br><span class="line">    UserRefer <span class="type">uint</span> <span class="string">`gorm:"index:,unique"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Which creates join table: user_profiles</span></span><br><span class="line"><span class="comment">//   foreign key: user_refer_id, reference: users.refer</span></span><br><span class="line"><span class="comment">//   foreign key: profile_refer, reference: profiles.user_refer</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意：</strong> 某些数据库只允许在唯一索引字段上创建外键，如果您在迁移时会创建外键，则需要指定 <code>unique index</code> 标签。</p></blockquote><h2 id="自引用-Many2Many" class="article-heading"><a href="#自引用-Many2Many" class="headerlink" title="自引用 Many2Many"></a>自引用 Many2Many<a class="article-anchor" href="#自引用-Many2Many" aria-hidden="true"></a></h2><p>自引用 many2many 关系</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">    Friends []*User <span class="string">`gorm:"many2many:user_friends"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Which creates join table: user_friends</span></span><br><span class="line"><span class="comment">//   foreign key: user_id, reference: users.id</span></span><br><span class="line"><span class="comment">//   foreign key: friend_id, reference: users.id</span></span><br></pre></td></tr></tbody></table></figure><h2 id="预加载" class="article-heading"><a href="#预加载" class="headerlink" title="预加载"></a>预加载<a class="article-anchor" href="#预加载" aria-hidden="true"></a></h2><p>GORM 可以通过 <code>Preload</code> 预加载 has many 关联的记录，查看 <a href="preload.html">预加载</a> 获取详情</p><h2 id="Many2Many-的-CURD" class="article-heading"><a href="#Many2Many-的-CURD" class="headerlink" title="Many2Many 的 CURD"></a>Many2Many 的 CURD<a class="article-anchor" href="#Many2Many-的-CURD" aria-hidden="true"></a></h2><p>查看 <a href="associations.html#Association-Mode">关联模式</a> 获取 many2many 相关的用法</p><h2 id="自定义连接表" class="article-heading"><a href="#自定义连接表" class="headerlink" title="自定义连接表"></a>自定义连接表<a class="article-anchor" href="#自定义连接表" aria-hidden="true"></a></h2><p><code>连接表</code> 可以是一个全功能的模型，支持 <code>Soft Delete</code>、<code>钩子</code>、更多的字段，就跟其它模型一样。您可以通过 <code>SetupJoinTable</code> 指定它，例如：</p><blockquote class="note warn"><p><strong>注意：</strong> 自定义连接表要求外键是复合主键或复合唯一索引</p></blockquote><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  Addresses []Address <span class="string">`gorm:"many2many:person_addresses;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Address <span class="keyword">struct</span> {</span><br><span class="line">  ID   <span class="type">uint</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PersonAddress <span class="keyword">struct</span> {</span><br><span class="line">  PersonID  <span class="type">int</span> <span class="string">`gorm:"primaryKey"`</span></span><br><span class="line">  AddressID <span class="type">int</span> <span class="string">`gorm:"primaryKey"`</span></span><br><span class="line">  CreatedAt time.Time</span><br><span class="line">  DeletedAt gorm.DeletedAt</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(PersonAddress)</span></span> BeforeCreate(db *gorm.DB) <span class="type">error</span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Change model Person's field Addresses' join table to PersonAddress</span></span><br><span class="line"><span class="comment">// PersonAddress must defined all required foreign keys or it will raise error</span></span><br><span class="line">err := db.SetupJoinTable(&amp;Person{}, <span class="string">"Addresses"</span>, &amp;PersonAddress{})</span><br></pre></td></tr></tbody></table></figure><h2 id="外键约束" class="article-heading"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束<a class="article-anchor" href="#外键约束" aria-hidden="true"></a></h2><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:"many2many:user_speaks;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> {</span><br><span class="line">  Code <span class="type">string</span> <span class="string">`gorm:"primarykey"`</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// CREATE TABLE `user_speaks` (`user_id` integer,`language_code` text,PRIMARY KEY (`user_id`,`language_code`),CONSTRAINT `fk_user_speaks_user` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE,CONSTRAINT `fk_user_speaks_language` FOREIGN KEY (`language_code`) REFERENCES `languages`(`code`) ON DELETE SET NULL ON UPDATE CASCADE);</span></span><br></pre></td></tr></tbody></table></figure><p>你也可以在删除记录时通过 <code>Select</code> 来删除 many2many 关系的记录，查看 <a href="associations.html#delete_with_select">Delete with Select</a> 获取详情</p><h2 id="复合外键" class="article-heading"><a href="#复合外键" class="headerlink" title="复合外键"></a>复合外键<a class="article-anchor" href="#复合外键" aria-hidden="true"></a></h2><p>如果您的模型使用了 <a href="composite_primary_key.html">复合主键</a>，GORM 会默认启用复合外键。</p><p>您也可以覆盖默认的外键、指定多个外键，只需用逗号分隔那些键名，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Tag <span class="keyword">struct</span> {</span><br><span class="line">  ID     <span class="type">uint</span>   <span class="string">`gorm:"primaryKey"`</span></span><br><span class="line">  Locale <span class="type">string</span> <span class="string">`gorm:"primaryKey"`</span></span><br><span class="line">  Value  <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blog <span class="keyword">struct</span> {</span><br><span class="line">  ID         <span class="type">uint</span>   <span class="string">`gorm:"primaryKey"`</span></span><br><span class="line">  Locale     <span class="type">string</span> <span class="string">`gorm:"primaryKey"`</span></span><br><span class="line">  Subject    <span class="type">string</span></span><br><span class="line">  Body       <span class="type">string</span></span><br><span class="line">  Tags       []Tag <span class="string">`gorm:"many2many:blog_tags;"`</span></span><br><span class="line">  LocaleTags []Tag <span class="string">`gorm:"many2many:locale_blog_tags;ForeignKey:id,locale;References:id"`</span></span><br><span class="line">  SharedTags []Tag <span class="string">`gorm:"many2many:shared_blog_tags;ForeignKey:id;References:id"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Join Table: blog_tags</span></span><br><span class="line"><span class="comment">//   foreign key: blog_id, reference: blogs.id</span></span><br><span class="line"><span class="comment">//   foreign key: blog_locale, reference: blogs.locale</span></span><br><span class="line"><span class="comment">//   foreign key: tag_id, reference: tags.id</span></span><br><span class="line"><span class="comment">//   foreign key: tag_locale, reference: tags.locale</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Join Table: locale_blog_tags</span></span><br><span class="line"><span class="comment">//   foreign key: blog_id, reference: blogs.id</span></span><br><span class="line"><span class="comment">//   foreign key: blog_locale, reference: blogs.locale</span></span><br><span class="line"><span class="comment">//   foreign key: tag_id, reference: tags.id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Join Table: shared_blog_tags</span></span><br><span class="line"><span class="comment">//   foreign key: blog_id, reference: blogs.id</span></span><br><span class="line"><span class="comment">//   foreign key: tag_id, reference: tags.id</span></span><br></pre></td></tr></tbody></table></figure><p>查看 <a href="composite_primary_key.html">复合主键</a> 获取详情</p></body></html>              </div>                            <div>