<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">编写插件</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="Callbacks" class="article-heading"><a href="#Callbacks" class="headerlink" title="Callbacks"></a>Callbacks<a class="article-anchor" href="#Callbacks" aria-hidden="true"></a></h2><p>GORM 自身也是基于 <code>Callbacks</code> 的，包括 <code>Create</code>、<code>Query</code>、<code>Update</code>、<code>Delete</code>、<code>Row</code>、<code>Raw</code>。此外，您也完全可以根据自己的意愿自定义 GORM</p><p>回调会注册到全局 <code>*gorm.DB</code>，而不是会话级别。如果您想要 <code>*gorm.DB</code> 具有不同的回调，您需要初始化另一个 <code>*gorm.DB</code></p><h3 id="注册-Callback" class="article-heading"><a href="#注册-Callback" class="headerlink" title="注册 Callback"></a>注册 Callback<a class="article-anchor" href="#注册-Callback" aria-hidden="true"></a></h3><p>注册 callback 至 callbacks</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cropImage</span><span class="params">(db *gorm.DB)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> db.Statement.Schema != <span class="literal">nil</span> {</span><br><span class="line">    <span class="comment">// 裁剪图片字段并上传到CDN，dummy code</span></span><br><span class="line">    <span class="keyword">for</span> _, field := <span class="keyword">range</span> db.Statement.Schema.Fields {</span><br><span class="line">      <span class="keyword">switch</span> db.Statement.ReflectValue.Kind() {</span><br><span class="line">      <span class="keyword">case</span> reflect.Slice, reflect.Array:</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; db.Statement.ReflectValue.Len(); i++ {</span><br><span class="line">          <span class="comment">// 从字段中获取数值</span></span><br><span class="line">          <span class="keyword">if</span> fieldValue, isZero := field.ValueOf(db.Statement.ReflectValue.Index(i)); !isZero {</span><br><span class="line">            <span class="keyword">if</span> crop, ok := fieldValue.(CropInterface); ok {</span><br><span class="line">              crop.Crop()</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      <span class="keyword">case</span> reflect.Struct:</span><br><span class="line">        <span class="comment">// 从字段中获取数值</span></span><br><span class="line">        <span class="keyword">if</span> fieldValue, isZero := field.ValueOf(db.Statement.ReflectValue); !isZero {</span><br><span class="line">          <span class="keyword">if</span> crop, ok := fieldValue.(CropInterface); ok {</span><br><span class="line">            crop.Crop()</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将值设置给字段</span></span><br><span class="line">        err := field.Set(db.Statement.ReflectValue, <span class="string">"newValue"</span>)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前实体的所有字段</span></span><br><span class="line">    db.Statement.Schema.Fields</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前实体的所有主键字段</span></span><br><span class="line">    db.Statement.Schema.PrimaryFields</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优先主键字段：带有数据库名称`id`或第一个定义的主键的字段。</span></span><br><span class="line">    db.Statement.Schema.PrioritizedPrimaryField</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前模型的所有关系</span></span><br><span class="line">    db.Statement.Schema.Relationships</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用字段名或数据库名查找字段</span></span><br><span class="line">    field := db.Statement.Schema.LookUpField(<span class="string">"Name"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// processing</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Callback().Create().Register(<span class="string">"crop_image"</span>, cropImage)</span><br><span class="line"><span class="comment">// 为Create注册一个回调</span></span><br></pre></td></tr></tbody></table></figure><h3 id="删除-Callback" class="article-heading"><a href="#删除-Callback" class="headerlink" title="删除 Callback"></a>删除 Callback<a class="article-anchor" href="#删除-Callback" aria-hidden="true"></a></h3><p>从 callbacks 中删除回调</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Callback().Create().Remove(<span class="string">"gorm:create"</span>)</span><br><span class="line"><span class="comment">// 从 Create 的 callbacks 中删除 `gorm:create`</span></span><br></pre></td></tr></tbody></table></figure><h3 id="替换-Callback" class="article-heading"><a href="#替换-Callback" class="headerlink" title="替换 Callback"></a>替换 Callback<a class="article-anchor" href="#替换-Callback" aria-hidden="true"></a></h3><p>用一个新的回调替换已有的同名回调</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Callback().Create().Replace(<span class="string">"gorm:create"</span>, newCreateFunction)</span><br><span class="line"><span class="comment">// 用新函数 `newCreateFunction` 替换 Create 流程目前的 `gorm:create`</span></span><br></pre></td></tr></tbody></table></figure><h3 id="注册带顺序的-Callback" class="article-heading"><a href="#注册带顺序的-Callback" class="headerlink" title="注册带顺序的 Callback"></a>注册带顺序的 Callback<a class="article-anchor" href="#注册带顺序的-Callback" aria-hidden="true"></a></h3><p>注册带顺序的 Callback</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// gorm:create 之前</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">"gorm:create"</span>).Register(<span class="string">"update_created_at"</span>, updateCreated)</span><br><span class="line"></span><br><span class="line"><span class="comment">// gorm:create 之后</span></span><br><span class="line">db.Callback().Create().After(<span class="string">"gorm:create"</span>).Register(<span class="string">"update_created_at"</span>, updateCreated)</span><br><span class="line"></span><br><span class="line"><span class="comment">// gorm:query 之后</span></span><br><span class="line">db.Callback().Query().After(<span class="string">"gorm:query"</span>).Register(<span class="string">"my_plugin:after_query"</span>, afterQuery)</span><br><span class="line"></span><br><span class="line"><span class="comment">// gorm:delete 之后</span></span><br><span class="line">db.Callback().Delete().After(<span class="string">"gorm:delete"</span>).Register(<span class="string">"my_plugin:after_delete"</span>, afterDelete)</span><br><span class="line"></span><br><span class="line"><span class="comment">// gorm:update 之前</span></span><br><span class="line">db.Callback().Update().Before(<span class="string">"gorm:update"</span>).Register(<span class="string">"my_plugin:before_update"</span>, beforeUpdate)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位于 gorm:before_create 之后 gorm:create 之前</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">"gorm:create"</span>).After(<span class="string">"gorm:before_create"</span>).Register(<span class="string">"my_plugin:before_create"</span>, beforeCreate)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有其它 callback 之前</span></span><br><span class="line">db.Callback().Create().Before(<span class="string">"*"</span>).Register(<span class="string">"update_created_at"</span>, updateCreated)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有其它 callback 之后</span></span><br><span class="line">db.Callback().Create().After(<span class="string">"*"</span>).Register(<span class="string">"update_created_at"</span>, updateCreated)</span><br></pre></td></tr></tbody></table></figure><h3 id="预定义-Callback" class="article-heading"><a href="#预定义-Callback" class="headerlink" title="预定义 Callback"></a>预定义 Callback<a class="article-anchor" href="#预定义-Callback" aria-hidden="true"></a></h3><p>GORM 已经定义了 <a target="_blank" rel="noopener" href="https://github.com/go-gorm/gorm/blob/master/callbacks/callbacks.go">一些 callback</a> 来支持当前的 GORM 功能，在启动您的插件之前可以先看看这些 callback</p><h2 id="插件" class="article-heading"><a href="#插件" class="headerlink" title="插件"></a>插件<a class="article-anchor" href="#插件" aria-hidden="true"></a></h2><p>GORM 提供了 <code>Use</code> 方法来注册插件，插件需要实现 <code>Plugin</code> 接口</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> {</span><br><span class="line">  Name() <span class="type">string</span></span><br><span class="line">  Initialize(*gorm.DB) <span class="type">error</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>当插件首次注册到 GORM 时将调用 <code>Initialize</code> 方法，且 GORM 会保存已注册的插件，你可以这样访问访问：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Config.Plugins[pluginName]</span><br></pre></td></tr></tbody></table></figure><p>查看 <a href="prometheus.html">Prometheus</a> 的例子</p></body></html>              </div>                            <div>