<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">自定义数据类型</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>GORM 提供了少量接口，使用户能够为 GORM 定义支持的数据类型，这里以 <a target="_blank" rel="noopener" href="https://github.com/go-gorm/datatypes/blob/master/json.go">json</a> 为例</p><h2 id="实现自定义数据类型" class="article-heading"><a href="#实现自定义数据类型" class="headerlink" title="实现自定义数据类型"></a>实现自定义数据类型<a class="article-anchor" href="#实现自定义数据类型" aria-hidden="true"></a></h2><h3 id="Scanner-x2F-Valuer" class="article-heading"><a href="#Scanner-x2F-Valuer" class="headerlink" title="Scanner / Valuer"></a>Scanner / Valuer<a class="article-anchor" href="#Scanner-x2F-Valuer" aria-hidden="true"></a></h3><p>自定义的数据类型必须实现 <a target="_blank" rel="noopener" href="https://pkg.go.dev/database/sql#Scanner">Scanner</a> 和 <a target="_blank" rel="noopener" href="https://pkg.go.dev/database/sql/driver#Valuer">Valuer</a> 接口，以便让 GORM 知道如何将该类型接收、保存到数据库</p><p>例如:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> JSON json.RawMessage</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 sql.Scanner 接口，Scan 将 value 扫描至 Jsonb</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j *JSON)</span></span> Scan(value <span class="keyword">interface</span>{}) <span class="type">error</span> {</span><br><span class="line">  bytes, ok := value.([]<span class="type">byte</span>)</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> errors.New(fmt.Sprint(<span class="string">"Failed to unmarshal JSONB value:"</span>, value))</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  result := json.RawMessage{}</span><br><span class="line">  err := json.Unmarshal(bytes, &amp;result)</span><br><span class="line">  *j = JSON(result)</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 driver.Valuer 接口，Value 返回 json value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j JSON)</span></span> Value() (driver.Value, <span class="type">error</span>) {</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(j) == <span class="number">0</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> json.RawMessage(j).MarshalJSON()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>有许多第三方包实现了 <code>Scanner</code>/<code>Valuer</code> 接口，可与 GORM 一起使用，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"github.com/google/uuid"</span></span><br><span class="line">  <span class="string">"github.com/lib/pq"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Post <span class="keyword">struct</span> {</span><br><span class="line">  ID     uuid.UUID <span class="string">`gorm:"type:uuid;default:uuid_generate_v4()"`</span></span><br><span class="line">  Title  <span class="type">string</span></span><br><span class="line">  Tags   pq.StringArray <span class="string">`gorm:"type:text[]"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="GormDataTypeInterface" class="article-heading"><a href="#GormDataTypeInterface" class="headerlink" title="GormDataTypeInterface"></a>GormDataTypeInterface<a class="article-anchor" href="#GormDataTypeInterface" aria-hidden="true"></a></h3><p>GORM 会从 <code>type</code> <a href="models.html#tags">标签</a> 中读取字段的数据库类型，如果找不到，则会检查该结构体是否实现了 <code>GormDBDataTypeInterface</code> 或 <code>GormDataTypeInterface</code> 接口，然后使用接口返回值作为数据类型</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> GormDataTypeInterface <span class="keyword">interface</span> {</span><br><span class="line">  GormDataType() <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GormDBDataTypeInterface <span class="keyword">interface</span> {</span><br><span class="line">  GormDBDataType(*gorm.DB, *schema.Field) <span class="type">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><code>GormDataType</code> 的结果用于生成通用数据类型，也可以通过 <code>schema.Field</code> 的 <code>DataType</code> 字段得到。这在 <a href="write_plugins.html">编写插件</a> 或者 <a href="hooks.html">hook</a> 时可能会有用，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(JSON)</span></span> GormDataType() <span class="type">string</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"json"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  Attrs JSON</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(user User)</span></span> BeforeCreate(tx *gorm.DB) {</span><br><span class="line">  field := tx.Statement.Schema.LookUpField(<span class="string">"Attrs"</span>)</span><br><span class="line">  <span class="keyword">if</span> field.DataType == <span class="string">"json"</span> {</span><br><span class="line">    <span class="comment">// 做点什么...</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在迁移时，<code>GormDBDataType</code> 通常会为当前驱动返回恰当的数据类型，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(JSON)</span></span> GormDBDataType(db *gorm.DB, field *schema.Field) <span class="type">string</span> {</span><br><span class="line">  <span class="comment">// 使用 field.Tag、field.TagSettings 获取字段的 tag</span></span><br><span class="line">  <span class="comment">// 查看 https://github.com/go-gorm/gorm/blob/master/schema/field.go 获取全部的选项</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据不同的数据库驱动返回不同的数据类型</span></span><br><span class="line">  <span class="keyword">switch</span> db.Dialector.Name() {</span><br><span class="line">  <span class="keyword">case</span> <span class="string">"mysql"</span>, <span class="string">"sqlite"</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"JSON"</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">"postgres"</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"JSONB"</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如果 struct 没有实现 <code>GormDBDataTypeInterface</code> 或 <code>GormDataTypeInterface</code> 接口，GORM 会根据 struct 第一个字段推测其数据类型，例如：会为 <code>NullString</code> 使用 <code>string</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> NullString <span class="keyword">struct</span> {</span><br><span class="line">  String <span class="type">string</span> <span class="comment">// 使用第一个字段的数据类型</span></span><br><span class="line">  Valid  <span class="type">bool</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  Name NullString <span class="comment">// 数据类型会是 string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="GormValuerInterface" class="article-heading"><a href="#GormValuerInterface" class="headerlink" title="GormValuerInterface"></a><span id="gorm_valuer_interface">GormValuerInterface</span><a class="article-anchor" href="#GormValuerInterface" aria-hidden="true"></a></h3><p>GORM 提供了 <code>GormValuerInterface</code> 接口，支持使用 SQL 表达式或基于 context 的值进行 create/update，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// GORM Valuer interface</span></span><br><span class="line"><span class="keyword">type</span> GormValuerInterface <span class="keyword">interface</span> {</span><br><span class="line">  GormValue(ctx context.Context, db *gorm.DB) clause.Expr</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="使用-SQL-表达式进行-Create-x2F-Update" class="article-heading"><a href="#使用-SQL-表达式进行-Create-x2F-Update" class="headerlink" title="使用 SQL 表达式进行 Create/Update"></a>使用 SQL 表达式进行 Create/Update<a class="article-anchor" href="#使用-SQL-表达式进行-Create-x2F-Update" aria-hidden="true"></a></h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> {</span><br><span class="line">    X, Y <span class="type">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span></span> GormDataType() <span class="type">string</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"geometry"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span></span> GormValue(ctx context.Context, db *gorm.DB) clause.Expr {</span><br><span class="line">  <span class="keyword">return</span> clause.Expr{</span><br><span class="line">    SQL:  <span class="string">"ST_PointFromText(?)"</span>,</span><br><span class="line">    Vars: []<span class="keyword">interface</span>{}{fmt.Sprintf(<span class="string">"POINT(%d %d)"</span>, loc.X, loc.Y)},</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Scan 方法实现了 sql.Scanner 接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc *Location)</span></span> Scan(v <span class="keyword">interface</span>{}) <span class="type">error</span> {</span><br><span class="line">  <span class="comment">// Scan a value into struct from database driver</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID       <span class="type">int</span></span><br><span class="line">  Name     <span class="type">string</span></span><br><span class="line">  Location Location</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Create(&amp;User{</span><br><span class="line">  Name:     <span class="string">"jinzhu"</span>,</span><br><span class="line">  Location: Location{X: <span class="number">100</span>, Y: <span class="number">100</span>},</span><br><span class="line">})</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`name`,`point`) VALUES ("jinzhu",ST_PointFromText("POINT(100 100)"))</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>}).Updates(User{</span><br><span class="line">  Name:  <span class="string">"jinzhu"</span>,</span><br><span class="line">  Location: Location{X: <span class="number">100</span>, Y: <span class="number">100</span>},</span><br><span class="line">})</span><br><span class="line"><span class="comment">// UPDATE `user_with_points` SET `name`="jinzhu",`location`=ST_PointFromText("POINT(100 100)") WHERE `id` = 1</span></span><br></pre></td></tr></tbody></table></figure><p>你也可以根据 SQL 表达式进行 create/update，查看 <a href="create.html#create_from_sql_expr">Create From SQL Expr</a> 和 <a href="update.html#update_from_sql_expr">Update with SQL Expression</a> 获取详情</p><h4 id="基于-Context-的值" class="article-heading"><a href="#基于-Context-的值" class="headerlink" title="基于 Context 的值"></a>基于 Context 的值<a class="article-anchor" href="#基于-Context-的值" aria-hidden="true"></a></h4><p>如果你想创建或更新一个依赖于当前 context 的值，你也可以实现 <code>GormValuerInterface</code> 接口，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> EncryptedString <span class="keyword">struct</span> {</span><br><span class="line">  Value <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(es EncryptedString)</span></span> GormValue(ctx context.Context, db *gorm.DB) (expr clause.Expr) {</span><br><span class="line">  <span class="keyword">if</span> encryptionKey, ok := ctx.Value(<span class="string">"TenantEncryptionKey"</span>).(<span class="type">string</span>); ok {</span><br><span class="line">    <span class="keyword">return</span> clause.Expr{SQL: <span class="string">"?"</span>, Vars: []<span class="keyword">interface</span>{}{Encrypt(es.Value, encryptionKey)}}</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    db.AddError(errors.New(<span class="string">"invalid encryption key"</span>))</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="条件表达式" class="article-heading"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式<a class="article-anchor" href="#条件表达式" aria-hidden="true"></a></h3><p>如果你想构建一些查询 helper，你可以让 struct 实现 <code>clause.Expression</code> 接口：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Expression <span class="keyword">interface</span> {</span><br><span class="line">    Build(builder Builder)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>查看 <a target="_blank" rel="noopener" href="https://github.com/go-gorm/datatypes/blob/master/json.go">JSON</a> 和 <a href="sql_builder.html#clauses">SQL Builder</a> 获取详情，下面是一个示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 根据 Clause Expression 生成 SQL</span></span><br><span class="line">db.Find(&amp;user, datatypes.JSONQuery(<span class="string">"attributes"</span>).HasKey(<span class="string">"role"</span>))</span><br><span class="line">db.Find(&amp;user, datatypes.JSONQuery(<span class="string">"attributes"</span>).HasKey(<span class="string">"orgs"</span>, <span class="string">"orga"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// MySQL</span></span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE JSON_EXTRACT(`attributes`, '$.role') IS NOT NULL</span></span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE JSON_EXTRACT(`attributes`, '$.orgs.orga') IS NOT NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PostgreSQL</span></span><br><span class="line"><span class="comment">// SELECT * FROM "user" WHERE "attributes"::jsonb ? 'role'</span></span><br><span class="line"><span class="comment">// SELECT * FROM "user" WHERE "attributes"::jsonb -&gt; 'orgs' ? 'orga'</span></span><br><span class="line"></span><br><span class="line">db.Find(&amp;user, datatypes.JSONQuery(<span class="string">"attributes"</span>).Equals(<span class="string">"jinzhu"</span>, <span class="string">"name"</span>))</span><br><span class="line"><span class="comment">// MySQL</span></span><br><span class="line"><span class="comment">// SELECT * FROM `user` WHERE JSON_EXTRACT(`attributes`, '$.name') = "jinzhu"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PostgreSQL</span></span><br><span class="line"><span class="comment">// SELECT * FROM "user" WHERE json_extract_path_text("attributes"::json,'name') = 'jinzhu'</span></span><br></pre></td></tr></tbody></table></figure><h2 id="自定义数据类型集合" class="article-heading"><a href="#自定义数据类型集合" class="headerlink" title="自定义数据类型集合"></a>自定义数据类型集合<a class="article-anchor" href="#自定义数据类型集合" aria-hidden="true"></a></h2><p>我们创建了一个 Github 仓库，用于收集各种自定义数据类型<a target="_blank" rel="noopener" href="https://github.com/go-gorm/datatypes">https://github.com/go-gorm/datatypes</a>，非常欢迎同学们的 pull request ;)</p></body></html>              </div>                            <div>