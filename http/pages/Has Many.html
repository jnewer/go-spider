<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">Has Many</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="Has-Many" class="article-heading"><a href="#Has-Many" class="headerlink" title="Has Many"></a>Has Many<a class="article-anchor" href="#Has-Many" aria-hidden="true"></a></h2><p><code>has many</code> 与另一个模型建立了一对多的连接。 不同于 <code>has one</code>，拥有者可以有零或多个关联模型。</p><p>例如，您的应用包含 user 和 credit card 模型，且每个 user 可以有多张 credit card。</p><h3 id="Declare" class="article-heading"><a href="#Declare" class="headerlink" title="Declare"></a>Declare<a class="article-anchor" href="#Declare" aria-hidden="true"></a></h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// User 有多张 CreditCard，UserID 是外键</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Retrieve" class="article-heading"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve<a class="article-anchor" href="#Retrieve" aria-hidden="true"></a></h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Retrieve user list with edger loading credit cards</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetAll</span><span class="params">(db *gorm.DB)</span></span> ([]User, <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">var</span> users []User</span><br><span class="line">    err := db.Model(&amp;User{}).Preload(<span class="string">"CreditCards"</span>).Find(&amp;users).Error</span><br><span class="line">    <span class="keyword">return</span> users, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="重写外键" class="article-heading"><a href="#重写外键" class="headerlink" title="重写外键"></a>重写外键<a class="article-anchor" href="#重写外键" aria-hidden="true"></a></h2><p>要定义 <code>has many</code> 关系，同样必须存在外键。 默认的外键名是拥有者的类型名加上其主键字段名</p><p>例如，要定义一个属于 <code>User</code> 的模型，则其外键应该是 <code>UserID</code>。</p><p>此外，想要使用另一个字段作为外键，您可以使用 <code>foreignKey</code> 标签自定义它：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard <span class="string">`gorm:"foreignKey:UserRefer"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number    <span class="type">string</span></span><br><span class="line">  UserRefer <span class="type">uint</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="重写引用" class="article-heading"><a href="#重写引用" class="headerlink" title="重写引用"></a>重写引用<a class="article-anchor" href="#重写引用" aria-hidden="true"></a></h2><p>GORM 通常使用拥有者的主键作为外键的值。 对于上面的例子，它是 <code>User</code> 的 <code>ID</code> 字段。</p><p>为 user 添加 credit card 时，GORM 会将 user 的 <code>ID</code> 字段保存到 credit card 的 <code>UserID</code> 字段。</p><p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  MemberNumber <span class="type">string</span></span><br><span class="line">  CreditCards  []CreditCard <span class="string">`gorm:"foreignKey:UserNumber;references:MemberNumber"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number     <span class="type">string</span></span><br><span class="line">  UserNumber <span class="type">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="多态关联" class="article-heading"><a href="#多态关联" class="headerlink" title="多态关联"></a>多态关联<a class="article-anchor" href="#多态关联" aria-hidden="true"></a></h2><p>GORM 为 <code>has one</code> 和 <code>has many</code> 提供了多态关联支持，它会将拥有者实体的表名、主键都保存到多态类型的字段中。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> {</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Toys []Toy <span class="string">`gorm:"polymorphic:Owner;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Toy <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  OwnerID   <span class="type">int</span></span><br><span class="line">  OwnerType <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Create(&amp;Dog{Name: <span class="string">"dog1"</span>, Toys: []Toy{{Name: <span class="string">"toy1"</span>}, {Name: <span class="string">"toy2"</span>}}})</span><br><span class="line"><span class="comment">// INSERT INTO `dogs` (`name`) VALUES ("dog1")</span></span><br><span class="line"><span class="comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES ("toy1","1","dogs"), ("toy2","1","dogs")</span></span><br></pre></td></tr></tbody></table></figure><p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> {</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Toys []Toy <span class="string">`gorm:"polymorphic:Owner;polymorphicValue:master"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Toy <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  OwnerID   <span class="type">int</span></span><br><span class="line">  OwnerType <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Create(&amp;Dog{Name: <span class="string">"dog1"</span>, Toy: []Toy{{Name: <span class="string">"toy1"</span>}, {Name: <span class="string">"toy2"</span>}}})</span><br><span class="line"><span class="comment">// INSERT INTO `dogs` (`name`) VALUES ("dog1")</span></span><br><span class="line"><span class="comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES ("toy1","1","master"), ("toy2","1","master")</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Has-Many-的-CURD" class="article-heading"><a href="#Has-Many-的-CURD" class="headerlink" title="Has Many 的 CURD"></a>Has Many 的 CURD<a class="article-anchor" href="#Has-Many-的-CURD" aria-hidden="true"></a></h2><p>查看 <a href="associations.html#Association-Mode">关联模式</a> 获取 has many 相关的用法</p><h2 id="预加载" class="article-heading"><a href="#预加载" class="headerlink" title="预加载"></a>预加载<a class="article-anchor" href="#预加载" aria-hidden="true"></a></h2><p>GORM 可以通过 <code>Preload</code> 预加载 has many 关联的记录，查看 <a href="preload.html">预加载</a> 获取详情</p><h2 id="自引用-Has-Many" class="article-heading"><a href="#自引用-Has-Many" class="headerlink" title="自引用 Has Many"></a>自引用 Has Many<a class="article-anchor" href="#自引用-Has-Many" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  ManagerID *<span class="type">uint</span></span><br><span class="line">  Team      []User <span class="string">`gorm:"foreignkey:ManagerID"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="外键约束" class="article-heading"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束<a class="article-anchor" href="#外键约束" aria-hidden="true"></a></h2><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard <span class="string">`gorm:"constraint:OnUpdate:CASCADE,OnDelete:SET NULL;"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>你也可以在删除记录时通过 <code>Select</code> 来删除 has many 关联的记录，查看 <a href="associations.html#delete_with_select">Delete with Select</a> 获取详情</p></body></html>              </div>                            <div>