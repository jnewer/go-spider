<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">删除</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="删除一条记录" class="article-heading"><a href="#删除一条记录" class="headerlink" title="删除一条记录"></a>删除一条记录<a class="article-anchor" href="#删除一条记录" aria-hidden="true"></a></h2><p>删除一条记录时，删除对象需要指定主键，否则会触发 <a href="#batch_delete">批量 Delete</a>，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Email 的 ID 是 `10`</span></span><br><span class="line">db.Delete(&amp;email)</span><br><span class="line"><span class="comment">// DELETE from emails where id = 10;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带额外条件的删除</span></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Delete(&amp;email)</span><br><span class="line"><span class="comment">// DELETE from emails where id = 10 AND name = "jinzhu";</span></span><br></pre></td></tr></tbody></table></figure><h2 id="根据主键删除" class="article-heading"><a href="#根据主键删除" class="headerlink" title="根据主键删除"></a>根据主键删除<a class="article-anchor" href="#根据主键删除" aria-hidden="true"></a></h2><p>GORM 允许通过主键(可以是复合主键)和内联条件来删除对象，它可以使用数字（如以下例子。也可以使用字符串——译者注）。查看 <a href="query.html#inline_conditions">查询-内联条件（Query Inline Conditions）</a> 了解详情。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Delete(&amp;User{}, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;User{}, <span class="string">"10"</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;users, []<span class="type">int</span>{<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>})</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id IN (1,2,3);</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Delete-Hook" class="article-heading"><a href="#Delete-Hook" class="headerlink" title="Delete Hook"></a>Delete Hook<a class="article-anchor" href="#Delete-Hook" aria-hidden="true"></a></h2><p>对于删除操作，GORM 支持 <code>BeforeDelete</code>、<code>AfterDelete</code> Hook，在删除记录时会调用这些方法，查看 <a href="hooks.html">Hook</a> 获取详情</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeDelete(tx *gorm.DB) (err <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">"admin"</span> {</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"admin user not allowed to delete"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="批量删除" class="article-heading"><a href="#批量删除" class="headerlink" title="批量删除"></a><span id="batch_delete">批量删除</span><a class="article-anchor" href="#批量删除" aria-hidden="true"></a></h2><p>如果指定的值不包括主属性，那么 GORM 会执行批量删除，它将删除所有匹配的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"email LIKE ?"</span>, <span class="string">"%jinzhu%"</span>).Delete(&amp;Email{})</span><br><span class="line"><span class="comment">// DELETE from emails where email LIKE "%jinzhu%";</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;Email{}, <span class="string">"email LIKE ?"</span>, <span class="string">"%jinzhu%"</span>)</span><br><span class="line"><span class="comment">// DELETE from emails where email LIKE "%jinzhu%";</span></span><br></pre></td></tr></tbody></table></figure><h3 id="阻止全局删除" class="article-heading"><a href="#阻止全局删除" class="headerlink" title="阻止全局删除"></a>阻止全局删除<a class="article-anchor" href="#阻止全局删除" aria-hidden="true"></a></h3><p>如果在没有任何条件的情况下执行批量删除，GORM 不会执行该操作，并返回 <code>ErrMissingWhereClause </code> 错误</p><p>对此，你必须加一些条件，或者使用原生 SQL，或者启用 <code>AllowGlobalUpdate</code> 模式，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Delete(&amp;User{}).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"1 = 1"</span>).Delete(&amp;User{})</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE 1=1</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">"DELETE FROM users"</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users</span></span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session{AllowGlobalUpdate: <span class="literal">true</span>}).Delete(&amp;User{})</span><br><span class="line"><span class="comment">// DELETE FROM users</span></span><br></pre></td></tr></tbody></table></figure><h3 id="返回删除行的数据" class="article-heading"><a href="#返回删除行的数据" class="headerlink" title="返回删除行的数据"></a>返回删除行的数据<a class="article-anchor" href="#返回删除行的数据" aria-hidden="true"></a></h3><p>返回被删除的数据，仅适用于支持 Returning 的数据库，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 返回所有列</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">DB.Clauses(clause.Returning{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE role = "admin" RETURNING *</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 1, Name: "jinzhu", Role: "admin", Salary: 100}, {ID: 2, Name: "jinzhu.2", Role: "admin", Salary: 1000}}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指定的列</span></span><br><span class="line">DB.Clauses(clause.Returning{Columns: []clause.Column{{Name: <span class="string">"name"</span>}, {Name: <span class="string">"salary"</span>}}}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE role = "admin" RETURNING `name`, `salary`</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 0, Name: "jinzhu", Role: "", Salary: 100}, {ID: 0, Name: "jinzhu.2", Role: "", Salary: 1000}}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="软删除" class="article-heading"><a href="#软删除" class="headerlink" title="软删除"></a>软删除<a class="article-anchor" href="#软删除" aria-hidden="true"></a></h2><p>如果您的模型包含了一个 <code>gorm.deletedat</code> 字段（<code>gorm.Model</code> 已经包含了该字段)，它将自动获得软删除的能力！</p><p>拥有软删除能力的模型调用 <code>Delete</code> 时，记录不会从数据库中被真正删除。但 GORM 会将 <code>DeletedAt</code> 置为当前时间， 并且你不能再通过普通的查询方法找到该记录。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// user 的 ID 是 `111`</span></span><br><span class="line">db.Delete(&amp;user)</span><br><span class="line"><span class="comment">// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量删除</span></span><br><span class="line">db.Where(<span class="string">"age = ?"</span>, <span class="number">20</span>).Delete(&amp;User{})</span><br><span class="line"><span class="comment">// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE age = 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在查询时会忽略被软删除的记录</span></span><br><span class="line">db.Where(<span class="string">"age = 20"</span>).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;</span></span><br></pre></td></tr></tbody></table></figure><p>如果您不想引入 <code>gorm.Model</code>，您也可以这样启用软删除特性：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID      <span class="type">int</span></span><br><span class="line">  Deleted gorm.DeletedAt</span><br><span class="line">  Name    <span class="type">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="查找被软删除的记录" class="article-heading"><a href="#查找被软删除的记录" class="headerlink" title="查找被软删除的记录"></a>查找被软删除的记录<a class="article-anchor" href="#查找被软删除的记录" aria-hidden="true"></a></h3><p>您可以使用 <code>Unscoped</code> 找到被软删除的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Unscoped().Where(<span class="string">"age = 20"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="永久删除" class="article-heading"><a href="#永久删除" class="headerlink" title="永久删除"></a>永久删除<a class="article-anchor" href="#永久删除" aria-hidden="true"></a></h3><p>您也可以使用 <code>Unscoped</code> 永久删除匹配的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Unscoped().Delete(&amp;order)</span><br><span class="line"><span class="comment">// DELETE FROM orders WHERE id=10;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Delete-Flag" class="article-heading"><a href="#Delete-Flag" class="headerlink" title="Delete Flag"></a>Delete Flag<a class="article-anchor" href="#Delete-Flag" aria-hidden="true"></a></h3><p>By default, <code>gorm.Model</code> uses <code>*time.Time</code> as the value for the <code>DeletedAt</code> field, and it provides other data formats support with plugin <code>gorm.io/plugin/soft_delete</code></p><blockquote class="note warn"><p><strong>INFO</strong> when creating unique composite index for the DeletedAt field, you must use other data format like unix second/flag with plugin <code>gorm.io/plugin/soft_delete</code>‘s help, e.g:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/plugin/soft_delete"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span>                <span class="string">`gorm:"uniqueIndex:udx_name"`</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt <span class="string">`gorm:"uniqueIndex:udx_name"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></blockquote><h4 id="Unix-Second" class="article-heading"><a href="#Unix-Second" class="headerlink" title="Unix Second"></a>Unix Second<a class="article-anchor" href="#Unix-Second" aria-hidden="true"></a></h4><p>Use unix second as delete flag</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/plugin/soft_delete"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query</span></span><br><span class="line">SELECT * FROM users WHERE deleted_at = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete</span></span><br><span class="line">UPDATE users SET deleted_at = <span class="comment">/* current unix second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>You can also specify to use <code>milli</code> or <code>nano</code> seconds as the value, for example:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID    <span class="type">uint</span></span><br><span class="line">  Name  <span class="type">string</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt <span class="string">`gorm:"softDelete:milli"`</span></span><br><span class="line">  <span class="comment">// DeletedAt soft_delete.DeletedAt `gorm:"softDelete:nano"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query</span></span><br><span class="line">SELECT * FROM users WHERE deleted_at = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete</span></span><br><span class="line">UPDATE users SET deleted_at = <span class="comment">/* current unix milli second or nano second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="Use-1-x2F-0-AS-Delete-Flag" class="article-heading"><a href="#Use-1-x2F-0-AS-Delete-Flag" class="headerlink" title="Use 1 / 0 AS Delete Flag"></a>Use <code>1</code> / <code>0</code> AS Delete Flag<a class="article-anchor" href="#Use-1-x2F-0-AS-Delete-Flag" aria-hidden="true"></a></h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/plugin/soft_delete"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID    <span class="type">uint</span></span><br><span class="line">  Name  <span class="type">string</span></span><br><span class="line">  IsDel soft_delete.DeletedAt <span class="string">`gorm:"softDelete:flag"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query</span></span><br><span class="line">SELECT * FROM users WHERE is_del = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete</span></span><br><span class="line">UPDATE users SET is_del = <span class="number">1</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="Mixed-Mode" class="article-heading"><a href="#Mixed-Mode" class="headerlink" title="Mixed Mode"></a>Mixed Mode<a class="article-anchor" href="#Mixed-Mode" aria-hidden="true"></a></h4><p>Mixed mode can use <code>0</code>, <code>1</code> or unix seconds to mark data as deleted or not, and save the deleted time at the same time.</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  DeletedAt time.Time</span><br><span class="line">  IsDel     soft_delete.DeletedAt <span class="string">`gorm:"softDelete:flag,DeletedAtField:DeletedAt"`</span> <span class="comment">// use `1` `0`</span></span><br><span class="line">  <span class="comment">// IsDel     soft_delete.DeletedAt `gorm:"softDelete:,DeletedAtField:DeletedAt"` // use `unix second`</span></span><br><span class="line">  <span class="comment">// IsDel     soft_delete.DeletedAt `gorm:"softDelete:nano,DeletedAtField:DeletedAt"` // use `unix nano second`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query</span></span><br><span class="line">SELECT * FROM users WHERE is_del = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete</span></span><br><span class="line">UPDATE users SET is_del = <span class="number">1</span>, deleted_at = <span class="comment">/* current unix second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>                            <div>